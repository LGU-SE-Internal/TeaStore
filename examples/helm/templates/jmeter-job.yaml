{{- if .Values.jmeter.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "teastore.jmeter.fullname" . }}
  labels:
    {{- include "teastore.jmeter.labels" . | nindent 4 }}
spec:
  backoffLimit: {{ .Values.jmeter.backoffLimit }}
  template:
    metadata:
      labels:
        {{- include "teastore.jmeter.selectorLabels" . | nindent 8 }}
      annotations:
        {{- include "teastore.otel.podAnnotations" . | nindent 8 }}
      
    spec:
      restartPolicy: {{ .Values.jmeter.restartPolicy }}
      initContainers:
      - name: wait-for-registry
        image: busybox:latest
        command:
          - sh
          - -c
          - |
            echo "Waiting for all services to be registered in registry..."
            REGISTRY_HOST="{{ template "teastore.registry.url" . }}"
            REGISTRY_PORT="{{ .Values.registry.service.port }}"
            REQUIRED_SERVICES="tools.descartes.teastore.persistence tools.descartes.teastore.auth tools.descartes.teastore.image tools.descartes.teastore.recommender tools.descartes.teastore.webui"
            
            # Wait for registry service to be available
            until nc -z -v -w5 $REGISTRY_HOST $REGISTRY_PORT; do
              echo "Registry not available, waiting..."
              sleep 2
            done
            echo "Registry is available, checking service registration..."
            
            # Check if all required services are registered
            while true; do
              all_registered=true
              for service in $REQUIRED_SERVICES; do
                response=$(wget -q -O- http://$REGISTRY_HOST:$REGISTRY_PORT/tools.descartes.teastore.registry/rest/services/$service 2>/dev/null)
                # Check if response is not empty and contains at least one service instance
                if [ -z "$response" ] || [ "$response" = "[]" ]; then
                  echo "Service $service not yet registered, waiting..."
                  all_registered=false
                  break
                fi
              done
              
              if [ "$all_registered" = true ]; then
                echo "All required services are registered!"
                break
              fi
              sleep 5
            done
      containers:
      - name: jmeter
        image: {{ include "teastore.image" (dict "imageConfig" .Values.jmeter.image "global" .Values.global "Chart" .Chart) }}
        imagePullPolicy: {{ include "teastore.imagePullPolicy" (dict "imageConfig" .Values.jmeter.image "global" .Values.global) }}
        env:
        - name: HOSTNAME
          value: {{ .Values.jmeter.targetHost | quote }}
        - name: PORT
          value: {{ .Values.jmeter.targetPort | quote }}
        - name: NUM_USERS
          value: {{ .Values.jmeter.numUsers | quote }}
        - name: RAMP_UP
          value: {{ .Values.jmeter.rampUp | quote }}
        - name: DURATION
          value: {{ .Values.jmeter.duration | quote }}
        - name: TEST_PLAN
          value: {{ .Values.jmeter.testPlan | quote }}
        volumeMounts:
        - name: results
          mountPath: /jmeter/results
        resources:
          {{- toYaml .Values.jmeter.resources | nindent 10 }}
      volumes:
      - name: results
        emptyDir: {}
{{- end }}
